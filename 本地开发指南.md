# 本地开发文档

## 环境准备

### 1. 安装依赖

```bash
# 安装 Wrangler（全局或本地）
npm install

# 安装前端依赖
cd frontend
npm install
cd ..
```

### 2. 创建本地 KV 命名空间（首次运行）

```bash
# 登录 Cloudflare
npx wrangler login

# 创建 KV 命名空间
npx wrangler kv:namespace create MONITOR_DATA

# 记下返回的 ID，例如：
# id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

### 3. 更新 wrangler.toml

将上一步得到的 KV ID 填入 `wrangler.toml`：

```toml
kv_namespaces = [
  { binding = "MONITOR_DATA", id = "你的KV_ID" }
]
```

## 本地测试方式

### 方式一：完整本地模式（推荐）

```bash
# 一键启动（会自动构建前端）
npm run dev

# 或手动分步
npm run build:frontend  # 构建前端
npx wrangler dev        # 启动本地服务器
```

访问：`http://localhost:8787`

**特点：**
- ✅ 使用真实的 KV 存储（Cloudflare 提供）
- ✅ 可以测试完整功能
- ✅ 数据持久化
- ❌ 需要网络连接

### 方式二：完全离线模式

```bash
npx wrangler dev --local
```

**特点：**
- ✅ 完全本地运行，不需要网络
- ✅ 启动速度快
- ❌ 使用模拟的 KV（数据不持久）
- ❌ 重启后数据丢失

### 方式三：前端独立开发（修改样式/界面时）

```bash
cd frontend
npm run dev
```

访问：`http://localhost:5173`

**说明：**
- 前端默认会调用 `/api/*` 接口
- 需要同时运行 `npm run dev` 启动 Worker
- 或者修改 `frontend/vite.config.js` 添加代理配置

## 开发工作流

### 1. 修改 Worker 代码（API/监控逻辑）

```bash
# 启动开发服务器（带热重载）
npm run dev

# 修改 src/ 下的文件会自动重载
# - src/index.js   主入口
# - src/api.js     API 处理
# - src/monitor.js 监控逻辑
# - src/utils.js   工具函数
```

### 2. 修改前端代码（界面/样式）

```bash
# 方式A：独立开发（推荐，热重载更快）
cd frontend && npm run dev

# 方式B：完整测试
npm run build:frontend && npm run dev
```

### 3. 测试定时任务

```bash
# 手动触发监控
curl -X POST http://localhost:8787/api/monitor/trigger \
  -H "Authorization: Bearer YOUR_TOKEN"

# 或在浏览器控制台
fetch('/api/monitor/trigger', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
```

**注意：** 本地开发时 Cron 定时任务不会自动触发，需要手动触发。

## 常见问题

### Q1: 启动报错 "KV namespace not found"

**解决：**
1. 确认已运行 `wrangler kv:namespace create MONITOR_DATA`
2. 将返回的 ID 填入 `wrangler.toml`
3. 或使用 `--local` 模式：`npx wrangler dev --local`

### Q2: 前端 API 请求 404

**检查：**
- Worker 是否正常运行（`npm run dev`）
- 前端代理配置是否正确
- API 路径是否以 `/api/` 开头

### Q3: 热重载不生效

**解决：**
```bash
# 重启开发服务器
Ctrl+C
npm run dev
```

### Q4: 修改前端后看不到变化

**解决：**
```bash
# 重新构建前端
npm run build:frontend

# 或使用独立前端开发模式
cd frontend && npm run dev
```

## 调试技巧

### 1. 查看 Worker 日志

```bash
# 实时查看线上日志
npx wrangler tail

# 本地开发时直接看终端输出
```

### 2. 查看 KV 数据

```bash
# 查看 KV 中的所有键
npx wrangler kv:key list --namespace-id=你的KV_ID

# 查看特定键的值
npx wrangler kv:key get monitor_state --namespace-id=你的KV_ID

# 手动设置值（测试用）
npx wrangler kv:key put admin_password "test123" --namespace-id=你的KV_ID
```

### 3. 浏览器调试

打开浏览器开发者工具：
- **Network 标签**：查看 API 请求/响应
- **Console 标签**：查看前端日志
- **Application > Local Storage**：查看存储的 Token

## 部署测试

### 1. 测试部署（不影响生产环境）

```bash
# 部署到测试环境
npx wrangler deploy --env staging

# 查看测试环境日志
npx wrangler tail --env staging
```

### 2. 生产部署

```bash
npm run deploy
```

## 性能优化建议

1. **前端构建优化**
   ```bash
   cd frontend
   npm run build  # 自动压缩、Tree-shaking
   ```

2. **Worker 代码优化**
   - 减少 KV 读写次数
   - 使用 `ctx.waitUntil()` 处理非关键任务
   - 合理使用缓存

3. **监控频率调整**
   - 修改 `wrangler.toml` 中的 crons
   - 生产环境建议 `*/5 * * * *`（每5分钟）

## 更多资源

- [Cloudflare Workers 文档](https://developers.cloudflare.com/workers/)
- [Workers KV 文档](https://developers.cloudflare.com/kv/)
- [Wrangler CLI 文档](https://developers.cloudflare.com/workers/wrangler/)
- [Workers Assets 文档](https://developers.cloudflare.com/workers/static-assets/)
