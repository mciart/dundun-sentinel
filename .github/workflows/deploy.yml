name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  # æž„å»ºå’Œæµ‹è¯•
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # éƒ¨ç½²åˆ° Cloudflare Workers
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    needs: build
    # åªåœ¨ push åˆ°ä¸»åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘æ—¶éƒ¨ç½²
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Install dependencies
        run: npm install

      - name: Setup D1 Database
        id: d1_setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # è‡ªåŠ¨èŽ·å– Account ID
          CLOUDFLARE_ACCOUNT_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts?per_page=1" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[0].id')
          
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ] || [ "$CLOUDFLARE_ACCOUNT_ID" = "null" ]; then
            echo "æ— æ³•èŽ·å– Account IDï¼Œè¯·æ£€æŸ¥ API Token æƒé™"
            exit 1
          fi
          
          echo "èŽ·å–åˆ° Account ID: $CLOUDFLARE_ACCOUNT_ID"
          echo "account_id=$CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒå D1 æ•°æ®åº“
          echo "æ£€æŸ¥ D1 æ•°æ®åº“..."
          EXISTING_DB=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[] | select(.name=="dundun-sentinel-db") | .uuid')
          
          if [ -n "$EXISTING_DB" ] && [ "$EXISTING_DB" != "null" ]; then
            echo "æ‰¾åˆ°å·²å­˜åœ¨çš„ D1 æ•°æ®åº“: $EXISTING_DB"
            D1_ID="$EXISTING_DB"
          else
            echo "D1 æ•°æ®åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            # åˆ›å»ºæ–°çš„ D1 æ•°æ®åº“
            RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{"name":"dundun-sentinel-db"}')
            
            D1_ID=$(echo $RESPONSE | jq -r '.result.uuid')
            
            if [ -z "$D1_ID" ] || [ "$D1_ID" = "null" ]; then
              echo "åˆ›å»º D1 æ•°æ®åº“å¤±è´¥: $RESPONSE"
              exit 1
            fi
            
            echo "æˆåŠŸåˆ›å»º D1 æ•°æ®åº“: $D1_ID"
          fi
          
          echo "d1_id=$D1_ID" >> $GITHUB_OUTPUT

      - name: Update D1 Database ID in wrangler.toml
        run: |
          sed -i 's/database_id = ".*"/database_id = "${{ steps.d1_setup.outputs.d1_id }}"/g' wrangler.toml
          cat wrangler.toml

      - name: Initialize D1 Schema
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.d1_setup.outputs.account_id }}
          D1_ID: ${{ steps.d1_setup.outputs.d1_id }}
        run: |
          echo "åˆå§‹åŒ– D1 æ•°æ®åº“ schema..."
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰è¡¨
          CHECK_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/d1/database/$D1_ID/query" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"sql":"SELECT name FROM sqlite_master WHERE type=\"table\" AND name=\"sites\""}')
          
          TABLE_EXISTS=$(echo $CHECK_RESULT | jq -r '.result[0].results | length')
          
          if [ "$TABLE_EXISTS" = "0" ] || [ "$TABLE_EXISTS" = "null" ]; then
            echo "æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œæ‰§è¡Œ schema åˆå§‹åŒ–..."
            npx wrangler d1 execute dundun-sentinel-db --file=./schema.sql --remote
          else
            echo "æ•°æ®åº“è¡¨å·²å­˜åœ¨ï¼Œè·³è¿‡ schema åˆå§‹åŒ–"
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ steps.d1_setup.outputs.account_id }}

      - name: Deployment Success
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ðŸ“ åŽç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®ä½ çš„ Worker URL"
          echo "2. é»˜è®¤åŽå°è·¯å¾„: /admin"
          echo "3. é»˜è®¤å¯†ç : admin"
          echo "4. è¯·ç«‹å³ç™»å½•åŽå°ä¿®æ”¹é»˜è®¤å¯†ç ï¼"

  # PR é¢„è§ˆéƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
  preview:
    name: Preview Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Install dependencies
        run: npm ci

      - name: Get Account ID
        id: account_setup
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          CLOUDFLARE_ACCOUNT_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts?per_page=1" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[0].id')
          
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ] || [ "$CLOUDFLARE_ACCOUNT_ID" = "null" ]; then
            echo "æ— æ³•èŽ·å– Account ID"
            exit 1
          fi
          
          echo "account_id=$CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Deploy Preview (Dry Run)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ steps.account_setup.outputs.account_id }}
          command: deploy --dry-run
